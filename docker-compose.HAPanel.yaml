version: "3.9"

services:
  influxdb:
    container_name: influxdb
    image: "arm32v7/influxdb:1.8"
    ports:
      - "8086:8086"
    restart: always
    network_mode: bridge
    environment:
      INFLUXDB_HOSTNAME: influxdb
      INFLUXDB_HTTP_AUTH_ENABLED: "true"
      INFLUXDB_ADMIN_USERNAME: ${INFLUXDB_ADMIN_USERNAME}
      INFLUXDB_ADMIN_PASSWORD: ${INFLUXDB_ADMIN_PASSWORD}
      INFLUXDB_RETENTION_ENABLED: "true"
      INFLUXDB_RETENTION_CHECK_INTERVAL: 30m
    config:
      - source: influxdb-config
        target: /etc/influxdb/influxdb.conf
      - source: influxdb-init_db
        target: /docker-entrypoint-initdb.d/influxdb-init.iql
    volumes:
      - type: bind
        source: ./influxdb/db_data
        target: /var/lib/influxdb

  grafana:
    container_name: grafana
    image: grafana/grafana:7.5.6
    depends_on:
      - influxdb
    ports:
      - "3000:3000"
    environment:
      GF_INSTALL_PLUGINS: "grafana-clock-panel 1.0.1,grafana-simple-json-datasource 1.3.5"
      GF_SECURITY_ADMIN_USER__FILE: "/run/secrets/grafana_admin_user"
      GF_SECURITY_ADMIN_PASSWORD__FILE: "/run/secrets/grafana_admin_password"
      GF_USERS_DÃŸEFAULT_THEME: "dark"
      GF_SERVER_DOMAIN: "localhost"
      GF_SERVER_ROOT_URL: "http://localhost:3000/grafana"
    config:
      - source: grafana-config
        target: /etc/grafana/grafana.ini
    volumes:
      - type: bind
        source: ./grafana/data
        target: /var/lib/grafana
      - type: bind
        source: ./grafana/logs
        target: /var/log/grafana
      - type: bind
        source: ./grafana/plugins
        target: /var/lib/grafana/plugins
      - type: bind
        source: ./grafana/provisioning
        target: /etc/grafana/provisioning
    secrets:
      - grafana_admin_user
      - grafana_admin_password

  mosquitto:
    image: eclipse-mosquitto:${MOSQUITTO_VERSION:-latest}
    build:
      context: .
      dockerfile: dockerfile.mosquitto
      args:
        - MOSQUITTO_VERSION=${MOSQUITTO_VERSION:-latest}
    container_name: mosquitto
    environment:
      - MOSQUITTO_USERNAME=${MOSQUITTO_USERNAME}
      - MOSQUITTO_PASSWORD=${MOSQUITTO_PASSWORD}
    restart: always
    ports:
      - "1883:1883"
      - "9001:9001"
    configs:
      - source: mosquitto-config
        target: /mosquitto/config/mosquitto.conf
      - source: mosquitto-init_db
        target: /docker-entrypoint-initdb.d/init-influxdb.sh
    volumes:
      - type: bind
        source: ./mosquitto/data
        target: /mosquitto/data
      - type: bind
        source: ./mosquitto/log
        target: /mosquitto/log

  tasmoadmin:
    container_name: tasmoadmin
    image: raymondmm/tasmoadmin:v1.7.0
    ports:
      - "81:80"
    restart: always
    volumes:
      - type: bind
        source: ./tasmoadmin/data
        target: /data

config:
  # Influxdb
  influxdb-config:
    - file: ./influxdb/config/influxdb.conf
  influxdb-init_db:
    - file: ./influxdb/scripts/influxdb-init.iql
  # Grafana
  grafana-config:
    - file: ./grafana/config/grafana.ini
  # Mosquitto
  mosquitto-config:
    - file: ./mosquitto/config/mosquitto.conf
  mosquitto-passwords:
    - file: ./mosquitto/config/mosquitto.passwd
  mosquitto-init_db:
    -file: ./mosquitto/docker-entrypoint.sh

  influx_init:
    - file: ./configs/influxdb/init-influxdb.sh
  influx_user:
    - file: ./configs/influxdb/influxdb_user
  nodered_settings:
    - file: ./configs/nodered/nodered_settings.js
  nodered_package:
    - file: ./configs/nodered/nodered_package.json
  mosquitto_passwords:
    - file: ./configs/mosquitto/mosquitto_passwords
  mosquitto_settings:
    - file: ./configs/mosquitto/mosquitto.conf

networks:
  openhab_net:
    driver: overlay
    attachable: true

secrets:
  # influxdb_admin_user:
  #   file: "./sectrets/influxdb/influxdb_admin_user"
  # influxdb_admin_password:
  #   file: "./sectrets/influxdb/influxdb_admin_password"
  grafana_admin_user:
    file: "./sectrets/grafana/grafana_admin_user"
  grafana_admin_password:
    file: "./sectrets/grafana/grafana_admin_password"
